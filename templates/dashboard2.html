{% extends 'base.html' %}
{% block content %}
<h2>Sleep Insights</h2>


<form id = "date-range" action = '/insom-types.json'>
    Start date: <input type="date" name="start_date">
    <input type="submit">
</form>


<!-- Insights: average, median sleep; average, median insomnia -->
<section class="data-insights">
    <p>Average sleep per night: <span id="avg_sleep"></span> hours</p>
    <p>Median sleep per night: <span id="median_sleep"></span> hours</p>
    <p>Average insomnia severity: <span id="avg_insomnia"></span> / 10</p>
    <p>Median insomnia severity: <span id="median_insomnia"></span> / 10</p>
</section>


<!-- Insight: most common type of insomnia -->
<section class="data-insights">
    <p>Most frequent type of insomnia: <span id="most_frequent_type"></span> insomnia.</p>
</section>


<!-- Insight: factors that co-occur with insomnia -->
<section class="data-insights"> 
    <p>Insomnia happens more frequently when you also ______.</p>
</section><br><br><br><br>


<!-- Donut chart element -->
<div class="sleep-chart">
    <label for="donutChart">Occurrence of Insomnia Type (in days)<br>
    <canvas id="donutChart"></canvas>
    <div id="canvas"></div>
    <div id="donutLegend" class="chart-legend"></div>
    </label>
</div><br><br>


<!-- Bar chart element -->
<div class="sleep-chart">
    <label for="barChart">Hours of Sleep per Night<br>
    <canvas id="barChart"></canvas>
    <div id="barCanvas"></div>
    </label>
</div><br><br>


<!-- Line graph element -->
<div class="sleep-chart">
    <label for="lineChart">Insomnia Severity vs. Stress Level<br>
    <canvas id="lineChart"></canvas>
    <div id="lineCanvas"></div>
    <div id="lineLegend" class="chart-legend"></div>
    </label>
</div>


<script src="https://code.jquery.com/jquery.js"></script>
<script src="static/dashboard.js"></script>

<script>

    
    // Create canvas elements to add to empty div.
    var canvas_tag = '<canvas id="donutChart">'
    var bar_canvas_tag = '<canvas id="barChart">'
    var line_canvas_tag = '<canvas id="lineChart">'

    var options = {
      responsive: true
    };
    

    // Create donut chart. 
    function drawDonutChart(results) {

        $("#donutChart").remove()
        $("#canvas").append(canvas_tag)
        
        var ctx_donut = $("#donutChart").get(0).getContext("2d");
        var myDonutChart = new Chart(ctx_donut).Doughnut(results.donut_chart.insom_type, options);
        $('#donutLegend').html(myDonutChart.generateLegend());
        
    }



    // Create bar chart. 
    function drawBarChart(results) {

        $("#barChart").remove()
        $("#barCanvas").append(bar_canvas_tag)

        var ctx_bar = $("#barChart").get(0).getContext("2d");
        var myBarChart = new Chart(ctx_bar).Bar(results.bar_chart, options);
    }



    // Create line chart. 
    function drawLineChart(results) {

        $("#lineChart").remove()
        $("#lineCanvas").append(line_canvas_tag)

        var ctx_line = $("#lineChart").get(0).getContext("2d");
        var myLineChart = new Chart(ctx_line).Line(results.line_chart, options);
        $("#lineLegend").html(myLineChart.generateLegend());
    }



    // Add textual data insights. 
    function addDataInsights(results) {

            $("#avg_sleep").empty()
            $("#median_sleep").empty()
            $("#avg_insomnia").empty()
            $("#median_insomnia").empty()
            $("#most_frequent_type").empty()

            var avgSleep = results.avg_median.avg_sleep;
            $("#avg_sleep").append(avgSleep);
            var medianSleep = results.avg_median.median_sleep;
            $("#median_sleep").append(medianSleep)
            var avgInsomnia = results.avg_median.avg_insomnia;
            $("#avg_insomnia").append(avgInsomnia);
            var medianInsomnia = results.avg_median.median_insomnia;
            $("#median_insomnia").append(medianInsomnia);
            var mostFrequentType = results.donut_chart.most_frequent_type;
            $("#most_frequent_type").append(mostFrequentType);
    }



    // Create all charts & insights.  
    function createCharts(results) {
        drawDonutChart(results);
        drawBarChart(results);
        drawLineChart(results);
        addDataInsights(results); 
    }
    

    // WAY TO CONDENSE THESE 2 FUNCTIONS? 
    // Get user-submitted dates, pass to createCharts. 
    function getDateRange(evt) {

        evt.preventDefault();

        var formInputs = {
            "start_date": $("#date-range input[name=start_date]").val() 
        };

        $.get('/insom-types.json',
            formInputs,
            createCharts);   
    };



    function getDefaultDateRange(evt) {
        // evt.preventDefault();

        var formInputs = {
            "start_date": $("#date-range input[name=start_date]").val(),
            "end_date": $("#date-range input[name=end_date]").val() 
        };

        $.get('/insom-types.json',
            formInputs,
            createCharts);     
    };


    //On page load, create charts with default start_date. 
    $( document ).ready(getDefaultDateRange);
    //On submit, create charts with user-selected start_date. 
    $("#date-range").on("submit", getDateRange);

    




</script>



{% endblock %}